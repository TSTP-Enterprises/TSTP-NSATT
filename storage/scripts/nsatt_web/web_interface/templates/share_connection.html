{% extends "base.html" %}
{% block content %}
<section class="share-connection">
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <p id="modal-message"></p>
        </div>
    </div>

    <h2>Share Network Connection</h2>
    <div class="info-box">
        <p>Share an internet connection from one interface to another. The source interface should have an active internet connection.</p>
        <p>Note: Connection sharing will enable IP forwarding and configure NAT rules between the interfaces.</p>
    </div>
    <form action="{{ url_for('share_connection_route') }}" method="POST" onsubmit="return handleFormSubmit(event)">
        <div class="form-group">
            <label for="source_iface">Source Interface (Internet Connection):</label>
            <select id="source_iface" name="source_iface" required>
                {% for iface in interfaces %}
                <option value="{{ iface }}">{{ iface }}</option>
                {% endfor %}
            </select>
            <small class="help-text">Select the interface that has internet access</small>
        </div>
        <div class="form-group">
            <label for="target_iface">Target Interface (To Share To):</label>
            <select id="target_iface" name="target_iface" required>
                {% for iface in interfaces %}
                    {% if iface not in shared_targets %}
                    <option value="{{ iface }}">{{ iface }}</option>
                    {% else %}
                    <option value="{{ iface }}" disabled>{{ iface }} (Already a target)</option>
                    {% endif %}
                {% endfor %}
            </select>
            <small class="help-text">Select the interface that will receive the shared connection</small>
        </div>
        <input type="submit" value="Share Connection" class="btn btn-primary">
    </form>

    {% if shared_interfaces %}
    <section class="active-shares">
        <h3>Active Connection Shares</h3>
        <div class="shares-info">
            <p>The following interfaces are currently sharing connections:</p>
        </div>
        {% for source, target in shared_interfaces %}
        <div class="shared-interface">
            <div class="share-details">
                <span class="source">{{ source }}</span>
                <span class="arrow">â†’</span>
                <span class="target">{{ target }}</span>
            </div>
            <form action="{{ url_for('remove_connection_share') }}" method="POST" class="remove-form" onsubmit="return handleRemoveShare(event)">
                <input type="hidden" name="target_iface" value="{{ target }}">
                <button type="submit" class="remove-btn">Remove Share</button>
            </form>
        </div>
        {% endfor %}
    </section>
    {% endif %}

    <script>
        const modal = document.getElementById('message-modal');
        const closeButton = document.getElementsByClassName('close-button')[0];
        const modalMessage = document.getElementById('modal-message');

        function showModal(message) {
            modalMessage.textContent = message;
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 5000);
        }

        closeButton.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                showModal(result.message);
                if (result.success) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                }
            } catch (error) {
                showModal('An error occurred while processing your request');
            }
            return false;
        }

        async function handleRemoveShare(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                showModal(result.message);
                if (result.success) {
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                }
            } catch (error) {
                showModal('An error occurred while removing the share');
            }
            return false;
        }
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 5px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</section>
{% endblock %}
